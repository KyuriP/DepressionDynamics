---
title: "Example: Study on Dynamics of Depression"
subtitle: "This is an illustrative example to convey the concept of the study, focusing on the dynamics of depression using mechanistic models and statistical network models."
format: 
  html:
    toc: true
    code-fold: true
    code-summary: "Show the code"
    embed-resources: true
editor: visual
theme: cosmo  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE)
# install packages
library(modelr)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(patchwork)
library(qgraph)
library(psychonetrics)

source("euler_stochastic2.R")
```

## 1. Toy example

![](toymodel_mockup2.png){fig-align="center" width="70%"}

$dS_{it} = S_i(1-S_i)(\beta - \alpha S_i + S_j(1+\delta f(S_i)) dt + dW_t$

## 2. Simulating mechanism

```{r}
#| fig-height: 10

# function for boosting effect of other symptoms when symptom level is over 0.5
f <- function(x) {
  if(x >= 0.5 | is.nan(x)) 1 else 0
}

# define diff equations:
det_eq <- c(
  dSA ~ SA*(1-SA)*(bA - aA*SA + SC*(1+ dA*f(SA))),
  dSB ~ SB*(1-SB)*(bB - aB*SB + SA*(1+ dB*f(SB))),
  dSC ~ SC*(1-SC)*(bC - aC*SC + SB*(1+ dC*f(SC)))
)

# give noise:
sto_eq <-  c(dSA ~ .1,
             dSB ~ .1,
             dSC ~ .1)

# define the parameters (as a named vector):
## original params ##
parms1 <- c(bA = -.6, bB = -.5, bC = -.6, 
           aA = .3, aB = .2, aC = .4, 
           dA = .2, dB = .5, dC = .3)

## given shock ##
parms2 <- c(bA = .6, bB = .5, bC = .7, 
            aA = .1, aB = .01, aC = .2, 
            dA = .2, dB = .5, dC = .3)
  
# define the initial condition (as a named vector):
init <- c(SA = 0.3, SB = 0.5, SC= 0.8)

# define deltaT and the number of time steps:
deltaT <- .1 # timestep length
n_steps <- 2300 # must be a number greater than 1

# specify the standard deviation of the stochastic noise
D_stoeq1 <- .3 # before shock
D_stoeq2 <- .6 # after shock

set.seed(45678) # set the seed (system's behavior varies much by random noise)
# simulate :
# > shock given at t = 300
# > shock --> change b and noise S.D.
# > shock duration = 40 
# > after shock --> revert back to original parameters but noise S.D. remains larger (debating... reasonable?)

sde_out <- euler_stochastic2(
  deterministic_rate = det_eq,
  stochastic_rate = sto_eq,
  initial_condition = init,
  parameters1 = parms1,
  deltaT = deltaT,
  n_steps = n_steps,
  D1 = D_stoeq1,
  D2 = D_stoeq2,
  shock = TRUE,
  parameters2 = parms2, 
  t_shock = 300, 
  duration = 40
)

# each symptom level
p1 <- sde_out |>
  mutate(totalsymptom = SA + SB + SC) |>
  tidyr::pivot_longer(!c(t, totalsymptom), names_to = "symptoms") |>
  ggplot() +
  geom_line(aes(x = t, y = value, color = symptoms), alpha = 0.5) +
  # geom_line(aes(x = t, y = totalsymptom)) +
  labs(y = "", title ="Each symptom level") +
  theme_classic() +
  theme(legend.position="bottom")
  
# total symptom level
p2 <- sde_out |>
  mutate(totalsymptom = SA + SB + SC) |>
  ggplot(aes (x = t, y = totalsymptom)) +
  geom_line(col = "salmon") +
  labs(y = "", title = "Total symptom level") +
  theme_classic()

# patchwork
p1 / p2

```

## 3. Statistical network estimation

```{r, message = FALSE}
## fitting statistical networks:
beforeshock <- sde_out |> filter(t < 29.9) |> select(!t)
aftershock <- sde_out |> filter(t >=29.9) |> select(!t)

layout(t(1:2))
beforeGGM <- qgraph(cor_auto(beforeshock),
       graph = 'glasso',
       layout = 'spring',
       theme = 'colorblind',
       sampleSize = nrow(beforeshock),
       title = "beforeGGM")
# fix layout
L <- beforeGGM$layout

afterGGM <- qgraph(cor_auto(aftershock),
       graph = 'glasso',
       theme = 'colorblind',
       sampleSize = nrow(aftershock),
       title = "afterGGM",
       layout = L)

layout(t(1:2))
before <- gvar(beforeshock, estimator="FIML") %>% runmodel
beforeGVAR <- getmatrix(before, "PDC") |> 
  qgraph(theme = "colorblind", directed=TRUE, diag=TRUE,
       title = "beforeGVAR", labels = c("SA", "SB", "SC"),
       layout = L)

after <- gvar(aftershock, estimator="FIML") %>% runmodel
afterGVAR <- getmatrix(after, "PDC") |>
  qgraph(theme = "colorblind", directed=TRUE, diag=TRUE,
       title = "afterGVAR", labels = c("SA", "SB", "SC"),
       layout = L)
```
